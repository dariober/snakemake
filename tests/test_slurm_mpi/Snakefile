# Test case for slurm executor.
# Note that in reality, the mpi, account, and partition resources should be specified
# via --default-resources, in order to keep such infrastructure specific details out of the
# workflow definition.


localrules:
    all,
    clean,


rule all:
    input:
        "pi.calc",


rule clean:
    shell:
        "rm -f pi.calc"


rule compile:
    input:
        "pi_MPI.c",
    output:
        temp("pi_MPI"),
    log:
        "logs/compile.log",
    resources:
        mem_mb=0,
        account="runner",  # name of the slurm account in our CI
        partition="debug",  # name of the partition in our CI
    shell:
        "mpicc -o {output} {input} &> {log}"


rule calc_pi:
    input:
        "pi_MPI",
    output:
        "pi.calc",
    resources:
        mem_mb=0,
        tasks=2,
        mpi="srun",
        account="runner",  # name of the slurm account in our CI
        partition="debug",  # name of the partition in our CI
    shell:
        "{resources.mpi} {input} &> {output}"
